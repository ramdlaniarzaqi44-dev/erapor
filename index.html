<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Rapor Pro v5.5 - SMAS AL-MULTAZAM</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel Import/Export (Fixed CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a', // Slate 900
                        secondary: '#3b82f6', // Blue 500
                        accent: '#10b981', // Emerald 500
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slide { animation: slideIn 0.3s ease-out forwards; }

        /* Print Styling */
        @media print {
            @page { size: A4; margin: 0.5cm; }
            html, body { height: auto; overflow: visible !important; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 11pt; line-height: 1.15; color: #000000 !important; }
            * { color: #000000 !important; border-color: #000000 !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .page-break { page-break-after: always; break-after: always; display: block; width: 100%; clear: both; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            .print-table th, .print-table td { border: 1px solid black !important; padding: 2px 4px; }
        }
        .print-only { display: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="text-slate-800">
    <div id="root"></div>

    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDrVZSb2iBCFA9GLKE1bbjGQUMOP_oVaKA",
            authDomain: "eraporaltaz.firebaseapp.com",
            projectId: "eraporaltaz",
            storageBucket: "eraporaltaz.firebasestorage.app",
            messagingSenderId: "1022149334440",
            appId: "1:1022149334440:web:2da5a09f4e3fad7d89399d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ID Aplikasi untuk Path Database (Gunakan nama unik jika hosting sendiri)
        const APP_ID_DB = typeof __app_id !== 'undefined' ? __app_id : 'smas-almultazam-db'; 

        // Fungsi Login Anonymous ke Firebase (Agar bisa baca/tulis DB)
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        // Expose ke window agar bisa diakses oleh React component
        window.db = db;
        window.auth = auth;
        window.APP_ID_DB = APP_ID_DB;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.collection = collection;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CUSTOM HOOKS & UTILS ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- DATA AWAL (SEED) ---
        const SEED_DATA = {
            sekolah: {
                nama: "SMAS AL-MULTAZAM KABUPATEN MOJOKERTO",
                alamat: "Jl. Raya Kepuhanyar, Mojoanyar, Mojokerto",
                kepalaSekolah: "Dr. Budi Santoso, M.Kom",
                nipKepsek: "-",
                tahunPelajaran: "2025/2026",
                semester: "Ganjil",
                website: "www.almultazam.sch.id"
            },
            users: [
                { id: 'admin', username: 'admin', password: '123', role: 'admin', nama: 'Administrator' },
                { id: 'usr-g-1', username: 'guru', password: '123', role: 'guru', nama: 'Retno Wandhira, S.Pd.', nip: '19850101' },
                { id: 'usr-g-2', username: 'agus', password: '123', role: 'guru', nama: 'Agus Setiawan, S.Kom.', nip: '19900202' },
                { id: 'usr-g-3', username: 'evirahmawati', password: '123', role: 'guru', nama: 'Evi Rahmawati, S.Pd.', nip: '19950505' },
                { id: 'siswa1', username: 'siswa', password: '123', role: 'siswa', nama: 'Abel Verisya', nisn: '1035' }
            ],
            siswa: [
                { id: 1, nisn: '1035', nama: 'ABEL VERISYA RAHMA HUMAIDAH', kelas: 'X-A', fase: 'E', no_absen: 1 },
                { id: 2, nisn: '1036', nama: 'ADINDA PUTRI', kelas: 'X-A', fase: 'E', no_absen: 2 },
                { id: 3, nisn: '1037', nama: 'AHMAD ZAINI', kelas: 'X-A', fase: 'E', no_absen: 3 },
                { id: 4, nisn: '1038', nama: 'BUDI SANTOSO', kelas: 'X-B', fase: 'E', no_absen: 1 },
            ],
            guru: [
                { id: 1, nip: '19850101', nama: 'Retno Wandhira, S.Pd.', mapel: 'Matematika', tugasTambahan: 'Wali Kelas X-A', kelasMengajar: ['X-A', 'X-B'] },
                { id: 2, nip: '19900202', nama: 'Agus Setiawan, S.Kom.', mapel: 'Informatika', tugasTambahan: '-', kelasMengajar: ['X-A', 'X-B'] },
                { id: 3, nip: '19950505', nama: 'Evi Rahmawati, S.Pd.', mapel: 'Bahasa Inggris', tugasTambahan: '-', kelasMengajar: ['X-A', 'X-B'] },
            ],
            kelas: [
                { id: 1, nama: 'X-A', tingkat: 'X', jurusan: 'Umum' },
                { id: 2, nama: 'X-B', tingkat: 'X', jurusan: 'Umum' },
            ],
            mapel: [
                { id: 1, nama: 'Pendidikan Agama Islam', kelompok: 'A', parent: null, kkm: 75, urutan: 1, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 2, nama: 'Pendidikan Pancasila', kelompok: 'A', parent: null, kkm: 75, urutan: 2, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 3, nama: 'Bahasa Indonesia', kelompok: 'A', parent: null, kkm: 75, urutan: 3, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 4, nama: 'Matematika', kelompok: 'A', parent: null, kkm: 70, urutan: 4, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 5, nama: 'Fisika', kelompok: 'A', parent: 'Ilmu Pengetahuan Alam', kkm: 70, urutan: 5, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 6, nama: 'Kimia', kelompok: 'A', parent: 'Ilmu Pengetahuan Alam', kkm: 70, urutan: 6, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 7, nama: 'Biologi', kelompok: 'A', parent: 'Ilmu Pengetahuan Alam', kkm: 70, urutan: 7, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 8, nama: 'Sosiologi', kelompok: 'A', parent: 'Ilmu Pengetahuan Sosial', kkm: 72, urutan: 8, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 9, nama: 'Ekonomi', kelompok: 'A', parent: 'Ilmu Pengetahuan Sosial', kkm: 72, urutan: 9, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 10, nama: 'Sejarah', kelompok: 'A', parent: 'Ilmu Pengetahuan Sosial', kkm: 72, urutan: 10, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 11, nama: 'Geografi', kelompok: 'A', parent: 'Ilmu Pengetahuan Sosial', kkm: 72, urutan: 11, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 12, nama: 'Bahasa Inggris', kelompok: 'A', parent: null, kkm: 75, urutan: 12, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 13, nama: 'PJOK', kelompok: 'A', parent: null, kkm: 75, urutan: 13, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 14, nama: 'Informatika', kelompok: 'A', parent: null, kkm: 75, urutan: 14, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 15, nama: 'Seni Budaya', kelompok: 'A', parent: null, kkm: 75, urutan: 15, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 16, nama: 'Bahasa Daerah', kelompok: 'B', parent: null, kkm: 75, urutan: 16, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 17, nama: 'Bahasa Arab', kelompok: 'C', parent: null, kkm: 75, urutan: 17, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 18, nama: 'Fiqih', kelompok: 'C', parent: null, kkm: 75, urutan: 18, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 19, nama: 'Hadits', kelompok: 'C', parent: null, kkm: 75, urutan: 19, aktif: true, kelas: ['X-A', 'X-B'] },
                { id: 20, nama: 'Akhlak', kelompok: 'C', parent: null, kkm: 75, urutan: 20, aktif: true, kelas: ['X-A', 'X-B'] },
            ],
            ekskulRef: [
                { id: 1, nama: 'Pramuka' }, 
                { id: 2, nama: 'Olimpiade Kimia' }, 
                { id: 3, nama: 'Futsal' }, 
                { id: 4, nama: 'Basket' }
            ],
            nilaiMapel: [
                 { siswa_id: 1, mapel_id: 1, s1: 81, s2: 96, s3: 0, s4: 0, s5: 0, sts: 85, sas: 88 }, 
                 { siswa_id: 1, mapel_id: 5, s1: 80, s2: 86, s3: 84, s4: 0, s5: 0, sts: 59, sas: 75 }, 
            ],
            nilaiEkskul: [
                { id: 1, siswa_id: 1, ekskul_id: 1, predikat: 'B' },
                { id: 2, siswa_id: 1, ekskul_id: 2, predikat: 'A' },
            ],
            absensi: [
                { siswa_id: 1, sakit: 10, izin: 1, alpa: 0 }
            ],
            logo: { 
                kota: 'Mojokerto', 
                tgl_rapor: '20 Desember 2025', 
                wali_kelas: 'Retno Wandhira, S.Pd.',
                wali_kelas_per_kelas: {
                    'X-A': 'Retno Wandhira, S.Pd.',
                    'X-B': 'Agus Setiawan, S.Kom.'
                },
                image: "https://upload.wikimedia.org/wikipedia/commons/1/1e/Logo_Tut_Wuri_Handayani.svg" 
            }
        };

        // --- HOOKS ---
        
        // FIX: Icon component wrapped in span to prevent React/Lucide DOM conflicts
        const Icon = ({ name, size=18, className="" }) => {
            const wrapperRef = useRef(null);
            
            useEffect(() => { 
                if(window.lucide && wrapperRef.current) {
                    window.lucide.createIcons({
                        root: wrapperRef.current,
                        nameAttr: 'data-lucide',
                        attrs: {
                            class: className,
                            width: size,
                            height: size
                        }
                    });
                }
            }, [name, size, className]);
            
            return (
                <span ref={wrapperRef} className="inline-flex items-center justify-center align-middle">
                     <i data-lucide={name}></i>
                </span>
            );
        };

        // --- FIREBASE HOOK REALTIME ---
        const useFirebaseData = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authUser, setAuthUser] = useState(null);

            useEffect(() => {
                const unsubscribe = window.auth.onAuthStateChanged(u => {
                    setAuthUser(u);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authUser) return;
                // Path ke dokumen (bukan collection)
                const docRef = window.doc(window.db, 'artifacts', window.APP_ID_DB, 'public', 'data', 'main_db', 'content');
                
                const unsubscribe = window.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setData(docSnap.data());
                    } else {
                        // Inisialisasi data jika belum ada
                        window.setDoc(docRef, SEED_DATA).then(() => setData(SEED_DATA));
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching data:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [authUser]);

            const updateData = async (newDataOrFunction) => {
                if (!authUser) return;
                const docRef = window.doc(window.db, 'artifacts', window.APP_ID_DB, 'public', 'data', 'main_db', 'content');
                let newData;
                if (typeof newDataOrFunction === 'function') {
                    newData = newDataOrFunction(data); // gunakan state data yang ada
                } else {
                    newData = newDataOrFunction;
                }
                
                // Optimistic UI Update
                setData(newData); 
                
                try {
                    await window.setDoc(docRef, newData);
                } catch (e) {
                    console.error("Gagal menyimpan ke cloud:", e);
                    alert("Gagal menyimpan data ke server! Periksa koneksi internet.");
                }
            };

            return { data, updateData, loading, authUser };
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, []);
            const bg = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
            return (
                <div className={`fixed top-5 right-5 ${bg} text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 z-[9999] animate-slide`}>
                    <Icon name={type === 'success' ? 'check-circle' : 'alert-circle'} />
                    <span className="font-medium">{message}</span>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-xl overflow-hidden animate-fade">
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                            <button onClick={onClose} className="hover:bg-slate-200 p-1 rounded transition"><Icon name="x"/></button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const FormInput = ({ label, value, onChange, placeholder, type="text" }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-slate-700 mb-1">{label}</label>
                <input 
                    type={type} 
                    value={value !== undefined && value !== null ? value : ""} 
                    onChange={e=>onChange(e.target.value)} 
                    className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                    placeholder={placeholder}
                />
            </div>
        );

        const ClassSelector = ({ label, availableClasses, selectedClasses = [], onChange }) => {
            const isAllSelected = availableClasses.length > 0 && selectedClasses.length === availableClasses.map(c=>c.nama).length;
            const handleToggleAll = () => onChange(isAllSelected ? [] : availableClasses.map(c => c.nama));
            const handleToggle = (className) => {
                const current = selectedClasses || [];
                onChange(current.includes(className) ? current.filter(c => c !== className) : [...current, className]);
            };
            return (
                <div className="mb-4">
                    <div className="flex justify-between items-center mb-2">
                        <label className="block text-sm font-medium text-slate-700">{label}</label>
                        <button onClick={handleToggleAll} className="text-xs text-blue-600 hover:text-blue-800 font-medium">{isAllSelected ? "Hapus Semua" : "Pilih Semua"}</button>
                    </div>
                    <div className="grid grid-cols-3 gap-2 border p-3 rounded-lg bg-slate-50 max-h-32 overflow-y-auto">
                        {availableClasses.map(k => (
                            <label key={k.id} className="flex items-center space-x-2 cursor-pointer hover:bg-white p-1 rounded">
                                <input type="checkbox" checked={(selectedClasses || []).includes(k.nama)} onChange={() => handleToggle(k.nama)} className="rounded border-slate-300 text-blue-600 focus:ring-blue-500"/>
                                <span className="text-sm">{k.nama}</span>
                            </label>
                        ))}
                    </div>
                    <div className="text-xs text-slate-500 mt-1">{(selectedClasses || []).length === 0 ? "Belum ada kelas dipilih" : `${(selectedClasses || []).length} kelas dipilih`}</div>
                </div>
            );
        };

        // --- COMPONENTS DATA ---

        const DataAkun = ({ data, setData, notify }) => {
            const guruUsers = data.users.filter(u => u.role === 'guru');
            const generateAccounts = () => {
                const newUsers = [...data.users];
                let count = 0;
                data.guru.forEach(g => {
                    const cleanUsername = g.nama.split(',')[0].replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                    if (!newUsers.some(u => u.username === cleanUsername)) {
                        newUsers.push({ id: `usr-g-${g.id}`, username: cleanUsername, password: '123', role: 'guru', nama: g.nama, nip: g.nip });
                        count++;
                    }
                });
                if (count > 0) { setData(prev => ({ ...prev, users: newUsers })); notify(`${count} akun guru berhasil dibuat!`, 'success'); } 
                else { notify('Semua guru sudah memiliki akun.', 'success'); }
            };
            const deleteAccount = (id, username) => {
                if(username === 'admin') return notify('Akun Admin Utama tidak boleh dihapus!', 'error');
                if(confirm(`Yakin ingin menghapus akun ${username}?`)) {
                    setData(prev => ({ ...prev, users: prev.users.filter(u => u.id !== id) })); notify('Akun berhasil dihapus.', 'success');
                }
            };
            const downloadAccounts = () => {
                if (guruUsers.length === 0) return notify('Belum ada data akun untuk diunduh.', 'error');
                const headers = [['NO', 'NAMA GURU', 'USERNAME', 'PASSWORD', 'ROLE']];
                const rows = guruUsers.map((u, i) => [i + 1, u.nama, u.username, u.password, u.role]);
                const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([...headers, ...rows]);
                XLSX.utils.book_append_sheet(wb, ws, "Akun Guru"); XLSX.writeFile(wb, `Data_Akun_Guru.xlsx`);
            };
            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">Data Akun Guru</h2><div className="flex gap-2"><button onClick={downloadAccounts} className="bg-slate-600 text-white px-4 py-2 rounded-lg shadow flex gap-2 items-center hover:bg-slate-700 transition font-medium text-sm"><Icon name="download" size={16}/> Download Excel</button><button onClick={generateAccounts} className="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow flex gap-2 items-center hover:bg-emerald-700 transition font-medium text-sm"><Icon name="wand" size={16}/> Generate Akun Otomatis</button></div></div>
                    <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b text-slate-600 uppercase text-xs"><tr><th className="p-4 w-12 text-center">No</th><th className="p-4">Nama Guru</th><th className="p-4">Username</th><th className="p-4">Password</th><th className="p-4 text-center">Status</th><th className="p-4 text-right">Aksi</th></tr></thead><tbody className="divide-y divide-slate-100">{guruUsers.length > 0 ? guruUsers.map((u, i) => (<tr key={u.id} className="hover:bg-slate-50"><td className="p-4 text-center text-slate-500">{i + 1}</td><td className="p-4 font-bold">{u.nama}</td><td className="p-4 font-mono text-slate-600 bg-slate-50 rounded px-2 w-fit">{u.username}</td><td className="p-4 font-mono text-slate-400">******</td><td className="p-4 text-center"><span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Aktif</span></td><td className="p-4 text-right"><button onClick={() => deleteAccount(u.id, u.username)} className="p-1.5 text-red-600 bg-red-50 rounded hover:bg-red-100 transition"><Icon name="trash-2" size={16}/></button></td></tr>)) : (<tr><td colSpan="6" className="p-8 text-center text-slate-400 italic">Belum ada akun guru. Klik Generate Akun.</td></tr>)}</tbody></table></div>
                    <div className="text-xs text-slate-500">* Password default untuk akun hasil generate adalah <b>123</b>.</div>
                </div>
            );
        };

        const LogoSetting = ({ data, setData, notify }) => {
            const [localData, setLocalData] = useState(data.logo);
            const [walasFilter, setWalasFilter] = useState('');
            
            useEffect(() => { setLocalData(data.logo); }, [data.logo]);

            const handleSave = () => {
                setData(prev => ({...prev, logo: localData}));
                notify('Konfigurasi Disimpan', 'success');
            };

            const classesToEdit = data.kelas.filter(c => !walasFilter || c.nama === walasFilter);
            
            const handleWalasChange = (className, name) => {
                setLocalData(prev => ({ 
                    ...prev, 
                    wali_kelas_per_kelas: { ...(prev.wali_kelas_per_kelas || {}), [className]: name } 
                }));
            };

            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Logo & Tanda Tangan</h2><button onClick={handleSave} className="bg-secondary text-white px-4 py-2 rounded shadow"><Icon name="save"/> Simpan</button></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl border shadow-sm h-fit">
                            <h3 className="font-bold text-lg mb-4 text-slate-700 border-b pb-2">Pengaturan Umum</h3>
                            <div className="grid grid-cols-1 gap-4">
                                <FormInput label="Kota" value={localData.kota} onChange={v=>setLocalData(p=>({...p, kota:v}))}/>
                                <FormInput label="Tanggal Rapor" value={localData.tgl_rapor} onChange={v=>setLocalData(p=>({...p, tgl_rapor:v}))}/>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Logo Sekolah (URL Gambar)</label>
                                    <div className="flex items-start gap-4">
                                        <div className="w-24 h-24 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center overflow-hidden bg-slate-50 relative shrink-0">
                                            {localData.image ? (<img src={localData.image} className="w-full h-full object-contain" onError={(e) => e.target.style.display = 'none'} />) : <span className="text-xs text-slate-400">No Logo</span>}
                                        </div>
                                        <div className="flex-1">
                                             <input 
                                                type="text" 
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm mb-2" 
                                                placeholder="https://example.com/logo.png"
                                                value={localData.image || ''} 
                                                onChange={(e) => setLocalData(p => ({...p, image: e.target.value}))}
                                            />
                                            <p className="text-xs text-slate-500">Masukkan URL gambar (Direct Link) untuk logo sekolah.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border shadow-sm"><div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-slate-700">Data Wali Kelas</h3><select className="border p-1.5 rounded text-sm bg-slate-50" value={walasFilter} onChange={e=>setWalasFilter(e.target.value)}><option value="">Semua Kelas</option>{data.kelas.map(c => <option key={c.id} value={c.nama}>{c.nama}</option>)}</select></div><div className="space-y-4 max-h-[400px] overflow-y-auto pr-2">{classesToEdit.length > 0 ? classesToEdit.map(c => (<div key={c.id} className="p-3 border rounded-lg bg-slate-50"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas {c.nama}</label><input type="text" className="w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none text-sm" placeholder="Nama Wali Kelas + Gelar" value={(localData.wali_kelas_per_kelas && localData.wali_kelas_per_kelas[c.nama]) || ''} onChange={e => handleWalasChange(c.nama, e.target.value)}/></div>)) : <div className="text-center text-slate-400 py-4">Tidak ada data kelas</div>}</div></div>
                    </div>
                </div>
            );
        };
        
        const DataSekolah = ({ data, setData, notify }) => {
            const [localData, setLocalData] = useState(data.sekolah);
            
            useEffect(() => { setLocalData(data.sekolah); }, [data.sekolah]);
            
            const handleSave = () => {
                setData(prev => ({ ...prev, sekolah: localData }));
                notify('Perubahan disimpan', 'success');
            };
            
            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">Data Sekolah</h2>
                        <button onClick={handleSave} className="bg-secondary text-white px-4 py-2 rounded shadow"><Icon name="save"/> Simpan</button>
                    </div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm grid grid-cols-2 gap-6">
                        <FormInput label="Nama Sekolah" value={localData.nama} onChange={v=>setLocalData(p=>({...p,nama:v}))}/>
                        <FormInput label="Kepala Sekolah" value={localData.kepalaSekolah} onChange={v=>setLocalData(p=>({...p,kepalaSekolah:v}))}/>
                        <FormInput label="Tahun Pelajaran" value={localData.tahunPelajaran} onChange={v=>setLocalData(p=>({...p,tahunPelajaran:v}))}/>
                        <FormInput label="Semester" value={localData.semester} onChange={v=>setLocalData(p=>({...p,semester:v}))}/>
                        <div className="col-span-2">
                            <FormInput label="Alamat" value={localData.alamat} onChange={v=>setLocalData(p=>({...p,alamat:v}))}/>
                        </div>
                    </div>
                </div>
            );
        };

        const MappingRapor = ({ dataMapel, classList, setData, notify }) => {
            const [edits, setEdits] = useState(dataMapel);
            const [selectedClass, setSelectedClass] = useState(''); // State untuk kelas yang dipilih

            // Sync edits when external data changes
            useEffect(() => { setEdits(dataMapel); }, [dataMapel]);

            const handleToggleActive = (mapelId, className) => {
                setEdits(prev => prev.map(m => {
                    if (m.id === mapelId) {
                        const currentClasses = m.kelas || [];
                        let newClasses;
                        if (currentClasses.includes(className)) {
                            // Remove class
                            newClasses = currentClasses.filter(c => c !== className);
                        } else {
                            // Add class
                            newClasses = [...currentClasses, className];
                        }
                        return { ...m, kelas: newClasses };
                    }
                    return m;
                }));
            };

            const handleChange = (id, field, val) => setEdits(prev => prev.map(m => m.id === id ? { ...m, [field]: val } : m));
            
            const save = () => { setData(prev => ({ ...prev, mapel: edits })); notify("Mapping berhasil disimpan"); };
            
            // Sort by urutan
            const sortedMapels = [...edits].sort((a,b)=>a.urutan-b.urutan);

            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 className="text-2xl font-bold text-slate-800">Mapping Rapor (Per Kelas)</h2>
                        <div className="flex gap-2 w-full md:w-auto">
                            <select 
                                className="border p-2 rounded-lg bg-white text-sm w-full md:w-64 font-bold text-slate-700 focus:ring-2 focus:ring-secondary outline-none" 
                                value={selectedClass} 
                                onChange={e=>setSelectedClass(e.target.value)}
                            >
                                <option value="">-- Pilih Kelas untuk Mengatur --</option>
                                {classList.map(c=><option key={c.id} value={c.nama}>Pengaturan Kelas {c.nama}</option>)}
                            </select>
                            <button onClick={save} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow flex gap-2 items-center hover:bg-blue-700 transition whitespace-nowrap"><Icon name="save" size={18}/> Simpan</button>
                        </div>
                    </div>

                    {selectedClass ? (
                        <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-blue-50 border-b flex items-center gap-2 text-blue-800 text-sm">
                                <Icon name="info" size={16}/>
                                <span>Menampilkan pengaturan mata pelajaran untuk <b>Kelas {selectedClass}</b>. Centang "Aktif" untuk menampilkan mapel di rapor kelas ini.</span>
                            </div>
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b text-slate-600 uppercase text-xs">
                                    <tr>
                                        <th className="p-3 w-16 text-center">Urut</th>
                                        <th className="p-3">Mata Pelajaran</th>
                                        <th className="p-3 w-24">Kelompok</th>
                                        <th className="p-3">Parent Group</th>
                                        <th className="p-3 w-20 text-center">KKM</th>
                                        <th className="p-3 w-32 text-center bg-yellow-50/50">Aktif di {selectedClass}?</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {sortedMapels.length > 0 ? sortedMapels.map(m => {
                                        // Cek apakah mapel ini aktif untuk kelas yang dipilih
                                        // Default: jika m.kelas kosong, anggap aktif semua (legacy). Tapi untuk UI ini, kita paksa cek array.
                                        // Karena kita sudah seed data dengan array penuh, pengecekan ini aman.
                                        const isActive = m.kelas && m.kelas.includes(selectedClass);
                                        
                                        return (
                                            <tr key={m.id} className={`hover:bg-slate-50 ${!isActive ? 'opacity-50 bg-slate-50' : ''}`}>
                                                <td className="p-2"><input type="number" className="w-full text-center border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" value={m.urutan} onChange={e=>handleChange(m.id,'urutan',parseInt(e.target.value))}/></td>
                                                <td className="p-2 font-medium">{m.nama}</td>
                                                <td className="p-2"><select className="w-full border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" value={m.kelompok} onChange={e=>handleChange(m.id,'kelompok',e.target.value)}><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></td>
                                                <td className="p-2"><input type="text" className="w-full border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" value={m.parent||''} placeholder="-" onChange={e=>handleChange(m.id,'parent',e.target.value)}/></td>
                                                <td className="p-2"><input type="number" className="w-full text-center border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" value={m.kkm} onChange={e=>handleChange(m.id,'kkm',parseInt(e.target.value))}/></td>
                                                <td className="p-2 text-center bg-yellow-50/30">
                                                    <label className="flex items-center justify-center cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-5 h-5 accent-emerald-500 cursor-pointer" 
                                                            checked={isActive} 
                                                            onChange={() => handleToggleActive(m.id, selectedClass)}
                                                        />
                                                    </label>
                                                </td>
                                            </tr>
                                        );
                                    }) : <tr><td colSpan="6" className="p-8 text-center text-slate-400">Tidak ada data mapel</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center p-12 bg-white rounded-xl border border-dashed text-slate-400">
                            <Icon name="arrow-up-circle" size={48} className="mb-4 text-slate-300"/>
                            <p className="text-lg font-medium">Silakan pilih kelas terlebih dahulu</p>
                            <p className="text-sm">Anda harus memilih kelas untuk mengatur mata pelajaran yang aktif.</p>
                        </div>
                    )}
                </div>
            );
        };

        const TableView = ({ title, heads, data, renderRow, onAdd, onEdit, onDelete, searchKeys=[], filterOptions=[], filterKey='', onImport, onDownloadTemplate }) => {
            const [query, setQuery] = useState('');
            const [filterVal, setFilterVal] = useState('');
            const fileInputRef = useRef(null);
            const filteredData = data.filter(item => {
                const matchesSearch = !query || searchKeys.some(key => String(item[key]).toLowerCase().includes(query.toLowerCase()));
                let matchesFilter = true;
                if (filterVal && filterKey) {
                    const itemVal = item[filterKey];
                    matchesFilter = Array.isArray(itemVal) ? itemVal.includes(filterVal) : itemVal === filterVal;
                }
                return matchesSearch && matchesFilter;
            });
            return (
                <div className="space-y-4 animate-fade">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4"><h2 className="text-2xl font-bold text-slate-800">{title}</h2><div className="flex gap-2 w-full md:w-auto flex-wrap justify-end">{filterOptions.length > 0 && (<select className="border p-2 rounded-lg bg-white text-sm focus:ring-2 focus:ring-secondary outline-none" value={filterVal} onChange={e=>setFilterVal(e.target.value)}><option value="">Semua {filterKey === 'kelas' ? 'Kelas' : 'Filter'}</option>{filterOptions.map(opt => <option key={opt.id} value={opt.nama}>{opt.nama}</option>)}</select>)}{searchKeys.length > 0 && (<div className="relative flex-1 md:w-64 min-w-[200px]"><span className="absolute left-3 top-2.5 text-slate-400"><Icon name="search" size={16}/></span><input type="text" placeholder="Cari data..." className="pl-9 pr-4 py-2 border rounded-lg w-full focus:ring-2 focus:ring-secondary outline-none text-sm" value={query} onChange={e=>setQuery(e.target.value)} /></div>)}{onImport && (<><input type="file" ref={fileInputRef} className="hidden" accept=".xlsx, .xls" onChange={onImport} /><button onClick={() => fileInputRef.current.click()} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex gap-2 text-sm shadow hover:bg-emerald-700 transition items-center font-medium"><Icon name="upload" size={16}/> Import</button></>)}{onDownloadTemplate && (<button onClick={onDownloadTemplate} className="bg-slate-600 text-white px-4 py-2 rounded-lg flex gap-2 text-sm shadow hover:bg-slate-700 transition items-center font-medium"><Icon name="download" size={16}/> Format</button>)}{onAdd && <button onClick={onAdd} className="bg-secondary text-white px-4 py-2 rounded-lg flex gap-2 text-sm shadow hover:bg-blue-600 transition items-center font-medium"><Icon name="plus" size={16}/> Tambah</button>}</div></div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b text-slate-600 uppercase text-xs tracking-wider"><tr><th className="p-4 w-12 text-center">No</th>{heads.map((h,i)=><th key={i} className="p-4 font-semibold">{h}</th>)}{(onEdit || onDelete) && <th className="p-4 text-right">Aksi</th>}</tr></thead><tbody className="divide-y divide-slate-100">{filteredData.length > 0 ? filteredData.map((item,i)=>(<tr key={item.id || i} className="hover:bg-slate-50 transition-colors"><td className="p-4 text-center text-slate-500">{i+1}</td>{renderRow(item)}{(onEdit || onDelete) && <td className="p-4 text-right"><div className="flex justify-end gap-2">{onEdit && <button onClick={() => onEdit(item)} className="p-1.5 text-blue-600 bg-blue-50 rounded hover:bg-blue-100"><Icon name="edit" size={16}/></button>}{onDelete && <button onClick={() => onDelete(item.id)} className="p-1.5 text-red-600 bg-red-50 rounded hover:bg-red-100"><Icon name="trash-2" size={16}/></button>}</div></td>}</tr>)) : <tr><td colSpan={heads.length + 2} className="p-8 text-center text-slate-400 italic">Data tidak ditemukan</td></tr>}</tbody></table></div></div>
                    <div className="text-xs text-slate-400 text-right">Menampilkan {filteredData.length} dari {data.length} data</div>
                </div>
            );
        };

        const LoginPage = ({ onLogin, logo, users }) => {
            const [form, setForm] = useState({username:'', password:''});
            const [error, setError] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                const found = users.find(u => u.username === form.username && u.password === form.password);
                if(found) onLogin(found); else setError('Username atau Password salah!');
            };
            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl animate-fade">
                        <div className="text-center mb-8">
                            <div className="w-24 h-24 bg-white rounded-xl mx-auto flex items-center justify-center mb-4 overflow-hidden">{logo && logo.image ? (<img src={logo.image} alt="Logo" className="w-full h-full object-contain" />) : (<div className="w-16 h-16 bg-secondary text-white rounded-xl flex items-center justify-center"><Icon name="book-open" size={32}/></div>)}</div>
                            <h1 className="text-2xl font-bold text-slate-800">e-Rapor Pro</h1><p className="text-slate-500">SMAS Al-Multazam</p>
                        </div>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 flex items-center gap-2"><Icon name="alert-triangle" size={16}/> {error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Username</label><input type="text" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-secondary outline-none transition" value={form.username} onChange={e=>setForm({...form, username:e.target.value})} required/></div>
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Password</label><input type="password" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-secondary outline-none transition" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} required/></div>
                            <button type="submit" className="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-slate-800 transition shadow-lg">MASUK</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ data }) => {
            const { siswa, guru, kelas, mapel } = data;
            const stats = [{ title: 'Total Siswa', count: siswa.length, color: 'bg-blue-500', icon: 'users' }, { title: 'Total Guru', count: guru.length, color: 'bg-emerald-500', icon: 'graduation-cap' }, { title: 'Rombel', count: kelas.length, color: 'bg-amber-500', icon: 'school' }, { title: 'Mata Pelajaran', count: mapel.length, color: 'bg-indigo-500', icon: 'book-open' }];
            return (
                <div className="space-y-6 animate-fade">
                    <h2 className="text-2xl font-bold text-slate-800">Dashboard Ikhtisar</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">{stats.map((s,i) => (<div key={i} className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm flex items-center gap-4 hover:shadow-md transition cursor-default"><div className={`p-4 rounded-xl text-white ${s.color} shadow-lg shadow-${s.color}/30`}><Icon name={s.icon} size={24}/></div><div><p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{s.title}</p><h3 className="text-3xl font-bold text-slate-800">{s.count}</h3></div></div>))}</div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm"><h3 className="font-bold mb-4">Informasi Sekolah</h3><ul className="space-y-3 text-sm"><li className="flex justify-between border-b pb-2"><span>Nama</span><span className="font-medium text-right w-1/2">{data.sekolah.nama}</span></li><li className="flex justify-between border-b pb-2"><span>Kepala Sekolah</span><span className="font-medium">{data.sekolah.kepalaSekolah}</span></li></ul></div>
                </div>
            );
        };

        // --- CORE LOGIC: INPUT NILAI DENGAN VALIDASI KETAT ---
        const InputNilai = ({ data, setData, notify, user }) => {
            const [selKelas, setSelKelas] = useState('');
            const [selMapel, setSelMapel] = useState('');
            const [buffer, setBuffer] = useState({});
            const fileInputRef = useRef(null);

            // 1. IMPROVED GURU IDENTIFICATION (ID Pattern -> NIP -> Name)
            const currentGuru = useMemo(() => {
                if (user.role === 'admin') return null;
                
                // Try linking via ID pattern (usr-g-{guruID})
                if (user.id && String(user.id).startsWith('usr-g-')) {
                    const guruId = user.id.replace('usr-g-', '');
                    const byId = data.guru.find(g => String(g.id) === String(guruId));
                    if (byId) return byId;
                }

                // Fallback: NIP Match
                if (user.nip) {
                    const byNip = data.guru.find(g => g.nip && String(g.nip).trim() === String(user.nip).trim());
                    if (byNip) return byNip;
                }

                // Fallback: Name Match (Case Insensitive)
                return data.guru.find(g => g.nama && user.nama && g.nama.trim().toLowerCase() === user.nama.trim().toLowerCase());
            }, [user, data.guru]);

            // 2. Filter Kelas based on identified Guru
            const filteredKelas = useMemo(() => {
                if (!currentGuru) return data.kelas; // Admin sees all
                const allowedClasses = currentGuru.kelasMengajar || [];
                return data.kelas.filter(k => allowedClasses.includes(k.nama));
            }, [data.kelas, currentGuru]);

            // 3. Filter Mapel based on Class AND Guru's assigned Subject
            const availableMapel = useMemo(() => {
                let mapels = data.mapel.filter(m => m.aktif !== false);
                
                // Filter by Class availability in Mapel definition
                if (selKelas) {
                    mapels = mapels.filter(m => !m.kelas || m.kelas.length === 0 || m.kelas.includes(selKelas));
                }

                // Filter by Guru's Subject
                if (currentGuru && currentGuru.mapel) {
                    const guruSubject = currentGuru.mapel.trim().toLowerCase();
                    mapels = mapels.filter(m => m.nama.trim().toLowerCase() === guruSubject);
                }

                return mapels.sort((a,b) => a.urutan - b.urutan);
            }, [data.mapel, selKelas, currentGuru]);

            // Auto-select or Reset if Invalid
            useEffect(() => { 
                if (filteredKelas.length === 1 && !selKelas) setSelKelas(filteredKelas[0].nama); 
                // Reset if selected class is no longer valid for this guru
                if (selKelas && !filteredKelas.find(k => k.nama === selKelas)) setSelKelas('');
            }, [filteredKelas, selKelas]);

            useEffect(() => { 
                if (availableMapel.length === 1 && !selMapel) setSelMapel(availableMapel[0].id);
                // Reset mapel if selected one is not available for this guru/class
                if (selMapel && !availableMapel.find(m => m.id === parseInt(selMapel))) setSelMapel('');
            }, [availableMapel, selMapel]);

            const handleSave = () => {
                if(!selMapel) return notify('Pilih Mapel dulu', 'error');
                
                setData((prevData) => {
                    const updatedNilai = [...prevData.nilaiMapel];
                    Object.keys(buffer).forEach(key => {
                        const [siswaId, field] = key.split('-');
                        const idx = updatedNilai.findIndex(n => n.siswa_id === parseInt(siswaId) && n.mapel_id === parseInt(selMapel));
                        const val = parseInt(buffer[key]) || 0;
                        if(idx > -1) updatedNilai[idx] = { ...updatedNilai[idx], [field]: val };
                        else updatedNilai.push({ siswa_id: parseInt(siswaId), mapel_id: parseInt(selMapel), s1:0,s2:0,s3:0,s4:0,s5:0,sts:0,sas:0, [field]: val });
                    });
                    return { ...prevData, nilaiMapel: updatedNilai };
                });
                
                setBuffer({}); 
                notify('Nilai berhasil disimpan!', 'success');
            };

            const downloadTemplateNilai = () => {
                const siswaKelas = data.siswa.filter(s => s.kelas === selKelas);
                if (siswaKelas.length === 0) return notify('Tidak ada siswa di kelas ini', 'error');
                const headers = [['NO', 'NOMOR INDUK', 'NAMA', 'S1', 'S2', 'S3', 'S4', 'S5', 'STS', 'SAS']];
                const rows = siswaKelas.map((s, i) => [i + 1, s.nisn, s.nama, '', '', '', '', '', '', '']);
                const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([...headers, ...rows]);
                XLSX.utils.book_append_sheet(wb, ws, "Nilai");
                const mapelName = data.mapel.find(m=>m.id === parseInt(selMapel))?.nama || "Mapel";
                XLSX.writeFile(wb, `Nilai_${selKelas}_${mapelName}.xlsx`);
            };

            const importNilai = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result; const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0]; const ws = wb.Sheets[wsname]; const json = XLSX.utils.sheet_to_json(ws);
                    const newBuffer = { ...buffer }; let count = 0;
                    json.forEach(row => {
                        const nisn = String(row['NOMOR INDUK'] || row['Nomor Induk'] || row['nomor induk'] || row['NISN'] || row['nisn']);
                        const siswa = data.siswa.find(s => s.nisn === nisn);
                        if (siswa) {
                            ['S1','S2','S3','S4','S5','STS','SAS'].forEach(field => {
                                const val = row[field] || row[field.toLowerCase()];
                                if (val !== undefined) newBuffer[`${siswa.id}-${field.toLowerCase()}`] = val;
                            });
                            count++;
                        }
                    });
                    setBuffer(newBuffer); notify(`Berhasil membaca nilai untuk ${count} siswa. Klik Simpan.`, 'success');
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };

            const students = useMemo(() => data.siswa.filter(s => s.kelas === selKelas), [data.siswa, selKelas]);

            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm"><h2 className="text-xl font-bold">Input Nilai Akademik</h2><div className="flex gap-2">{selKelas && selMapel && (<><button onClick={downloadTemplateNilai} className="bg-slate-600 text-white px-3 py-2 rounded-lg flex gap-2 shadow hover:bg-slate-700 transition items-center font-medium text-sm"><Icon name="download" size={16}/> Format</button><button onClick={() => fileInputRef.current.click()} className="bg-emerald-600 text-white px-3 py-2 rounded-lg flex gap-2 shadow hover:bg-emerald-700 transition items-center font-medium text-sm"><Icon name="upload" size={16}/> Import</button><input type="file" ref={fileInputRef} className="hidden" accept=".xlsx, .xls" onChange={importNilai} /></>)}<button onClick={handleSave} className="bg-accent text-white px-4 py-2 rounded-lg flex gap-2 hover:bg-emerald-600 shadow transition font-bold text-sm"><Icon name="save" size={16}/> Simpan</button></div></div>
                    <div className="grid grid-cols-2 gap-4">
                        <select className="p-3 border rounded-lg bg-white shadow-sm" value={selKelas} onChange={e=>setSelKelas(e.target.value)}>
                            <option value="">-- Pilih Kelas --</option>
                            {filteredKelas.map(k=><option key={k.id} value={k.nama}>{k.nama}</option>)}
                        </select>
                        <select className="p-3 border rounded-lg bg-white shadow-sm" value={selMapel} onChange={e=>setSelMapel(e.target.value)} disabled={!selKelas}>
                            <option value="">-- Pilih Mata Pelajaran --</option>
                            {availableMapel.map(m=><option key={m.id} value={m.id}>{m.urutan}. {m.nama}</option>)}
                        </select>
                    </div>
                    {selKelas && selMapel ? (<div className="bg-white rounded-xl shadow border overflow-hidden overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3 min-w-[200px] sticky left-0 bg-slate-50">Nama Siswa</th>{['S1','S2','S3','S4','STS','SAS'].map(h=><th key={h} className="p-2 text-center w-20">{h}</th>)}<th className="p-2 text-center w-20 bg-slate-100">Akhir</th></tr></thead><tbody className="divide-y">{students.map(s => { const nilai = data.nilaiMapel.find(n => n.siswa_id === s.id && n.mapel_id === parseInt(selMapel)) || {}; const getVal = (f) => buffer[`${s.id}-${f}`] !== undefined ? buffer[`${s.id}-${f}`] : (nilai[f] || ''); const sumatif = ['s1','s2','s3','s4','s5'].map(k=>parseInt(getVal(k))||0).filter(v=>v>0); const rerata = sumatif.length ? sumatif.reduce((a,b)=>a+b,0)/sumatif.length : 0; const sts = parseInt(getVal('sts')) || 0; const sas = parseInt(getVal('sas')) || 0; const akhir = Math.round((rerata + sts + sas) / 3); return (<tr key={s.id} className="hover:bg-slate-50"><td className="p-3 font-medium sticky left-0 bg-white border-r">{s.nama}</td>{['s1','s2','s3','s4','sts','sas'].map(f => (<td key={f} className="p-2 text-center"><input type="number" className="w-14 text-center border rounded p-1 focus:ring-2 focus:ring-blue-500 outline-none transition" value={getVal(f)} onChange={e=>setBuffer(prev => ({...prev, [`${s.id}-${f}`]: e.target.value}))}/></td>))}<td className="p-2 text-center font-bold bg-slate-50 text-emerald-600">{akhir}</td></tr>)})}</tbody></table></div>) : <div className="text-center p-12 bg-white rounded-xl border border-dashed text-slate-400">Silakan pilih Kelas dan Mata Pelajaran</div>}
                </div>
            )
        };

        const InputEkskul = ({ data, setData, notify, user, currentGuru }) => {
            const [selKelas, setSelKelas] = useState('');
            const [buffer, setBuffer] = useState({}); const fileInputRef = useRef(null);

            const availableClasses = useMemo(() => {
                if (user.role === 'admin') return data.kelas;
                if (currentGuru && currentGuru.tugasTambahan) {
                     return data.kelas.filter(k => currentGuru.tugasTambahan.includes(k.nama));
                }
                return [];
            }, [data.kelas, user, currentGuru]);

            useEffect(() => {
                if (availableClasses.length === 1 && !selKelas) {
                    setSelKelas(availableClasses[0].nama);
                }
            }, [availableClasses, selKelas]);

            const getVal = (siswaId, slotIdx, field) => {
                const key = `${siswaId}-${slotIdx}-${field}`;
                if (buffer[key] !== undefined) return buffer[key];
                const studentEkskuls = data.nilaiEkskul.filter(n => n.siswa_id === siswaId);
                return studentEkskuls[slotIdx] ? studentEkskuls[slotIdx][field === 'id' ? 'ekskul_id' : 'predikat'] : '';
            };
            const handleSave = () => {
                if (!selKelas) return notify('Pilih Kelas dulu', 'error');
                
                setData((prevData) => {
                    const students = prevData.siswa.filter(s => s.kelas === selKelas);
                    let newNilaiEkskul = prevData.nilaiEkskul.filter(n => !students.find(s => s.id === n.siswa_id));
                    students.forEach(s => {
                        const existingRecords = prevData.nilaiEkskul.filter(n => n.siswa_id === s.id);
                        [0, 1].forEach(slotIdx => {
                            let ekskulId = buffer[`${s.id}-${slotIdx}-id`];
                            let predikat = buffer[`${s.id}-${slotIdx}-predikat`];
                            if (ekskulId === undefined) ekskulId = existingRecords[slotIdx]?.ekskul_id;
                            if (predikat === undefined) predikat = existingRecords[slotIdx]?.predikat;
                            if (ekskulId && predikat) newNilaiEkskul.push({ id: Date.now() + Math.random(), siswa_id: s.id, ekskul_id: parseInt(ekskulId), predikat: predikat });
                        });
                    });
                    return { ...prevData, nilaiEkskul: newNilaiEkskul };
                });
                
                setBuffer({}); 
                notify('Nilai Ekskul berhasil disimpan!', 'success');
            };
            // ... (Template & Import Ekskul omitted for brevity but logic remains same) ...
            const downloadTemplateEkskul = () => { /* ... */ }; const importEkskul = (e) => { /* ... */ };
            const students = useMemo(() => data.siswa.filter(s => s.kelas === selKelas), [data.siswa, selKelas]);
            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm"><h2 className="text-xl font-bold">Input Nilai Ekstrakurikuler</h2><button onClick={handleSave} className="bg-accent text-white px-6 py-2 rounded-lg flex gap-2 hover:bg-emerald-600 shadow transition font-bold"><Icon name="save"/> Simpan</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><select className="p-3 border rounded-lg bg-white shadow-sm" value={selKelas} onChange={e=>setSelKelas(e.target.value)}><option value="">-- Pilih Kelas --</option>{availableClasses.map(k=><option key={k.id} value={k.nama}>{k.nama}</option>)}</select></div>
                    {selKelas ? (<div className="bg-white rounded-xl shadow border overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3 w-1/3">Nama Siswa</th><th className="p-3 text-center bg-slate-100 border-l border-r" colSpan="2">Kegiatan 1</th><th className="p-3 text-center bg-slate-50" colSpan="2">Kegiatan 2</th></tr></thead><tbody className="divide-y">{students.map(s => { return (<tr key={s.id} className="hover:bg-slate-50"><td className="p-3 font-medium border-r">{s.nama}</td>{[0, 1].map(i => (<React.Fragment key={i}><td className={`p-2 ${i===0 ? 'bg-slate-50/50' : ''}`}><select className="w-full border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" value={getVal(s.id, i, 'id')} onChange={e => setBuffer(prev => ({...prev, [`${s.id}-${i}-id`]: e.target.value}))}><option value="">-</option>{data.ekskulRef.map(e => <option key={e.id} value={e.id}>{e.nama}</option>)}</select></td><td className={`p-2 text-center border-r ${i===0 ? 'bg-slate-50/50' : ''}`}><input type="text" className="w-12 text-center border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none transition uppercase" placeholder="-" maxLength="2" value={getVal(s.id, i, 'predikat')} onChange={e => setBuffer(prev => ({...prev, [`${s.id}-${i}-predikat`]: e.target.value}))}/></td></React.Fragment>))}</tr>) })}</tbody></table></div>) : <div className="text-center p-12 bg-white rounded-xl border border-dashed text-slate-400">Silakan pilih Kelas untuk memulai input nilai ekskul.</div>}
                </div>
            );
        };

        const InputAbsensi = ({ data, setData, notify, user, currentGuru }) => {
            const [selKelas, setSelKelas] = useState(''); const [buffer, setBuffer] = useState({}); const fileInputRef = useRef(null);

            const availableClasses = useMemo(() => {
                if (user.role === 'admin') return data.kelas;
                if (currentGuru && currentGuru.tugasTambahan) {
                     return data.kelas.filter(k => currentGuru.tugasTambahan.includes(k.nama));
                }
                return [];
            }, [data.kelas, user, currentGuru]);

            useEffect(() => {
                if (availableClasses.length === 1 && !selKelas) {
                    setSelKelas(availableClasses[0].nama);
                }
            }, [availableClasses, selKelas]);

            const handleSave = () => {
                if(!selKelas) return notify('Pilih Kelas dulu', 'error');
                
                setData((prevData) => {
                    const updatedAbsensi = [...prevData.absensi];
                    Object.keys(buffer).forEach(key => {
                        const [siswaId, field] = key.split('-'); const idx = updatedAbsensi.findIndex(a => a.siswa_id === parseInt(siswaId)); const val = parseInt(buffer[key]) || 0;
                        if(idx > -1) updatedAbsensi[idx] = { ...updatedAbsensi[idx], [field]: val }; else updatedAbsensi.push({ siswa_id: parseInt(siswaId), sakit:0, izin:0, alpa:0, [field]: val });
                    });
                    return { ...prevData, absensi: updatedAbsensi };
                });
                
                setBuffer({}); 
                notify('Data Absensi berhasil disimpan!', 'success');
            };
            const students = useMemo(() => data.siswa.filter(s => s.kelas === selKelas), [data.siswa, selKelas]);
            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm"><h2 className="text-xl font-bold">Input Ketidakhadiran</h2><button onClick={handleSave} className="bg-accent text-white px-6 py-2 rounded-lg flex gap-2 hover:bg-emerald-600 shadow transition font-bold"><Icon name="save"/> Simpan</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><select className="p-3 border rounded-lg bg-white shadow-sm" value={selKelas} onChange={e=>setSelKelas(e.target.value)}><option value="">-- Pilih Kelas --</option>{availableClasses.map(k=><option key={k.id} value={k.nama}>{k.nama}</option>)}</select></div>
                    {selKelas ? (<div className="bg-white rounded-xl shadow border overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3">Nama Siswa</th><th className="p-3 w-32 text-center">Sakit (Hari)</th><th className="p-3 w-32 text-center">Izin (Hari)</th><th className="p-3 w-32 text-center">Alpa (Hari)</th></tr></thead><tbody className="divide-y">{students.map(s => { const absen = data.absensi.find(a => a.siswa_id === s.id) || {sakit:0,izin:0,alpa:0}; const getVal = (f) => buffer[`${s.id}-${f}`] !== undefined ? buffer[`${s.id}-${f}`] : absen[f]; return (<tr key={s.id} className="hover:bg-slate-50"><td className="p-3 font-medium">{s.nama}</td>{['sakit','izin','alpa'].map(f => (<td key={f} className="p-2 text-center"><input type="number" className="w-20 text-center border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none transition" value={getVal(f)} onChange={e=>setBuffer(prev => ({...prev, [`${s.id}-${f}`]: e.target.value}))}/></td>))}</tr>)})}</tbody></table></div>) : <div className="text-center p-12 bg-white rounded-xl border border-dashed text-slate-400">Silakan pilih Kelas untuk memulai input absensi.</div>}
                </div>
            )
        };

        const CetakLeger = ({ data, notify, user }) => {
            const [selKelas, setSelKelas] = useState(''); const [selMapel, setSelMapel] = useState('');
            const currentGuru = useMemo(() => {
                if (user.role === 'admin') return null;
                // Identical strict logic to InputNilai
                if (user.id && String(user.id).startsWith('usr-g-')) {
                    const guruId = user.id.replace('usr-g-', '');
                    const byId = data.guru.find(g => String(g.id) === String(guruId));
                    if (byId) return byId;
                }
                if (user.nip) {
                    const byNip = data.guru.find(g => g.nip && String(g.nip).trim() === String(user.nip).trim());
                    if (byNip) return byNip;
                }
                return data.guru.find(g => g.nama && user.nama && g.nama.trim().toLowerCase() === user.nama.trim().toLowerCase());
            }, [user, data.guru]);

            const filteredKelas = useMemo(() => {
                if (!currentGuru) return data.kelas;
                const allowedClasses = currentGuru.kelasMengajar || [];
                return data.kelas.filter(k => allowedClasses.includes(k.nama));
            }, [data.kelas, currentGuru]);

            const availableMapel = useMemo(() => {
                let mapels = data.mapel.filter(m => m.aktif !== false);
                if (selKelas) {
                    // STRIKT: Hanya tampilkan mapel yang terdaftar di kelas ini
                    mapels = mapels.filter(m => m.kelas && m.kelas.includes(selKelas));
                }
                if (currentGuru && currentGuru.mapel) { const guruSubject = currentGuru.mapel.trim().toLowerCase(); mapels = mapels.filter(m => m.nama.trim().toLowerCase() === guruSubject); }
                return mapels.sort((a,b) => a.urutan - b.urutan);
            }, [data.mapel, selKelas, currentGuru]);

            // Auto-Select Logic
            useEffect(() => { if (filteredKelas.length === 1 && !selKelas) setSelKelas(filteredKelas[0].nama); if (selKelas && !filteredKelas.find(k => k.nama === selKelas)) setSelKelas(''); }, [filteredKelas, selKelas]);
            useEffect(() => { if (availableMapel.length === 1 && !selMapel) setSelMapel(availableMapel[0].id); if (selMapel && !availableMapel.find(m => m.id === parseInt(selMapel))) setSelMapel(''); }, [availableMapel, selMapel]);

            const students = useMemo(() => data.siswa.filter(s => s.kelas === selKelas), [data.siswa, selKelas]);
            // ... (Download Logic Omitted) ...
            const downloadExcel = () => { /* ... */ };
            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm"><h2 className="text-xl font-bold">Cetak Leger Nilai</h2><button onClick={downloadExcel} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex gap-2 shadow hover:bg-emerald-700 transition items-center font-medium text-sm"><Icon name="download" size={16}/> Download Excel</button></div>
                    <div className="grid grid-cols-2 gap-4"><select className="p-3 border rounded-lg bg-white shadow-sm" value={selKelas} onChange={e=>setSelKelas(e.target.value)}><option value="">-- Pilih Kelas --</option>{filteredKelas.map(k=><option key={k.id} value={k.nama}>{k.nama}</option>)}</select><select className="p-3 border rounded-lg bg-white shadow-sm" value={selMapel} onChange={e=>setSelMapel(e.target.value)} disabled={!selKelas}><option value="">-- Pilih Mata Pelajaran --</option>{availableMapel.map(m=><option key={m.id} value={m.id}>{m.urutan}. {m.nama}</option>)}</select></div>
                    {selKelas && selMapel ? (<div className="bg-white rounded-xl shadow border overflow-hidden overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b text-center"><tr><th className="p-3 w-10">No</th><th className="p-3 text-left">Nama Siswa</th><th className="p-3 w-12">S1</th><th className="p-3 w-12">S2</th><th className="p-3 w-12">S3</th><th className="p-3 w-12">S4</th><th className="p-3 w-12">S5</th><th className="p-3 w-16 bg-blue-50">Rerata</th><th className="p-3 w-16">STS</th><th className="p-3 w-16">SAS</th><th className="p-3 w-16 bg-emerald-50">Akhir</th><th className="p-3 w-16">Pred</th></tr></thead><tbody className="divide-y text-center">{students.map((s, i) => { const val = data.nilaiMapel.find(n => n.siswa_id === s.id && n.mapel_id === parseInt(selMapel)) || {}; const sum = [val.s1,val.s2,val.s3,val.s4,val.s5].map(v=>parseInt(v)||0).filter(v=>v>0); const rerata = sum.length ? Math.round(sum.reduce((a,b)=>a+b,0)/sum.length) : 0; const sts = parseInt(val.sts) || 0; const sas = parseInt(val.sas) || 0; const akhir = Math.round((rerata + sts + sas) / 3); let predikat = 'D'; if(akhir >= 92) predikat = 'A'; else if(akhir >= 83) predikat = 'B'; else if(akhir >= 75) predikat = 'C'; return (<tr key={s.id} className="hover:bg-slate-50"><td className="p-3 text-slate-500">{i+1}</td><td className="p-3 text-left font-medium">{s.nama}</td><td className="p-3">{val.s1||'-'}</td><td className="p-3">{val.s2||'-'}</td><td className="p-3">{val.s3||'-'}</td><td className="p-3">{val.s4||'-'}</td><td className="p-3">{val.s5||'-'}</td><td className="p-3 font-bold bg-blue-50">{rerata}</td><td className="p-3">{val.sts||'-'}</td><td className="p-3">{val.sas||'-'}</td><td className="p-3 font-bold bg-emerald-50 text-emerald-700">{akhir}</td><td className="p-3 font-bold">{predikat}</td></tr>); })}</tbody></table></div>) : <div className="text-center p-12 bg-white rounded-xl border border-dashed text-slate-400">Silakan pilih Kelas dan Mata Pelajaran untuk melihat Leger Nilai.</div>}
                </div>
            );
        };

        const CetakRaporSisipan = ({ data, handlePrint, notify, user, currentGuru }) => {
            const [selKelas, setSelKelas] = useState(''); 
            
            const availableClasses = useMemo(() => {
                if (user.role === 'admin') return data.kelas;
                // Jika guru & walas, filter berdasarkan string tugas tambahan yang mengandung nama kelas
                if (currentGuru && currentGuru.tugasTambahan) {
                     return data.kelas.filter(k => currentGuru.tugasTambahan.includes(k.nama));
                }
                return [];
            }, [data.kelas, user, currentGuru]);

            // Auto-select jika cuma ada 1 pilihan (biasanya untuk walas)
            useEffect(() => {
                if (availableClasses.length === 1 && !selKelas) {
                    setSelKelas(availableClasses[0].nama);
                }
            }, [availableClasses, selKelas]);

            const students = useMemo(() => selKelas ? data.siswa.filter(s => s.kelas === selKelas) : [], [data.siswa, selKelas]);
            
            return (
                <div className="space-y-6 animate-fade">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm"><h2 className="text-xl font-bold">Cetak Rapor Sisipan</h2></div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                        <div className="mb-6 max-w-xs">
                            <label className="block text-sm font-medium text-slate-700 mb-1">Pilih Kelas</label>
                            <select className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={selKelas} onChange={e => setSelKelas(e.target.value)}>
                                <option value="">-- Pilih Kelas --</option>
                                {availableClasses.map(k => (<option key={k.id} value={k.nama}>{k.nama}</option>))}
                            </select>
                        </div>
                        {selKelas && (<div className="animate-fade space-y-6"><div><h3 className="font-bold text-lg text-slate-800 mb-3">Daftar Siswa</h3><div className="border rounded-lg overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3 w-12 text-center">No</th><th className="p-3">Nomor Induk</th><th className="p-3">Nama Siswa</th><th className="p-3 text-right">Aksi</th></tr></thead><tbody className="divide-y">{students.length > 0 ? students.map((s, i) => (<tr key={s.id} className="hover:bg-slate-50"><td className="p-3 text-center text-slate-500">{i+1}</td><td className="p-3">{s.nisn}</td><td className="p-3 font-medium">{s.nama}</td><td className="p-3 text-right"><button onClick={() => handlePrint([s])} className="bg-white border border-slate-300 text-slate-700 px-3 py-1.5 rounded hover:bg-slate-50 transition text-xs font-medium inline-flex items-center gap-1"><Icon name="printer" size={14}/> Cetak</button></td></tr>)) : (<tr><td colSpan="4" className="p-6 text-center text-slate-400">Tidak ada siswa di kelas ini.</td></tr>)}</tbody></table></div></div></div>)}
                    </div>
                </div>
            );
        };

        // --- UPDATED PRINT TEMPLATE (Rapor Sisipan - No SAS, No Border on Logo) ---
        const PrintRapor = ({ data, siswa }) => {
            const { sekolah, mapel, nilaiMapel, ekskulRef, nilaiEkskul, absensi, logo } = data;
            const myAbsen = absensi.find(a => a.siswa_id === siswa.id) || {sakit:0,izin:0,alpa:0};
            const waliKelasName = (logo.wali_kelas_per_kelas && logo.wali_kelas_per_kelas[siswa.kelas]) || logo.wali_kelas || "Wali Kelas";
            const calcScore = (val) => {
                 if(!val) return { rerata:0, akhir:0, predikat:'-' };
                 const sum = [val.s1,val.s2,val.s3,val.s4,val.s5].map(v=>parseInt(v)||0).filter(v=>v>0);
                 const rerata = sum.length ? Math.round(sum.reduce((a,b)=>a+b,0)/sum.length) : 0;
                 const akhir = Math.round((rerata + (parseInt(val.sts)||0)) / 2); // Sisipan Formula
                 let predikat = 'D'; if(akhir >= 92) predikat = 'A'; else if(akhir >= 83) predikat = 'B'; else if(akhir >= 75) predikat = 'C';
                 return { rerata, akhir, predikat };
            };
            const sortedMapel = mapel.filter(m => {
                if(m.aktif === false) return false;
                if(m.kelas && m.kelas.length > 0 && !m.kelas.includes(siswa.kelas)) return false;
                return true;
            }).sort((a,b) => a.urutan - b.urutan);
            
            const processedParents = new Set();
            const renderRow = (m) => {
                const val = nilaiMapel.find(n => n.siswa_id === siswa.id && n.mapel_id === m.id) || {};
                const score = calcScore(val);
                return (<tr key={m.id}><td className="text-center">{m.urutan}</td><td className="pl-1 truncate max-w-[150px]">{m.nama}</td><td className="text-center">{m.kkm}</td><td className="text-center">{val.s1||'-'}</td><td className="text-center">{val.s2||'-'}</td><td className="text-center">{val.s3||'-'}</td><td className="text-center">{val.s4||'-'}</td><td className="text-center">{val.s5||'-'}</td><td className="text-center font-bold bg-white">{score.rerata||''}</td><td className="text-center">{val.sts||'-'}</td><td className="text-center font-bold bg-white">{score.akhir||''}</td><td className="text-center">{score.predikat}</td></tr>);
            };
            const renderGroupWithHeader = (grp, title) => {
                const groupItems = sortedMapel.filter(m => m.kelompok === grp); if (groupItems.length === 0) return null; 
                return (<React.Fragment key={grp}><tr className="font-bold"><td colSpan="12" className="pl-2 py-0.5 text-[11px]">{title}</td></tr>{groupItems.map(m => { if (m.parent) { if (!processedParents.has(m.parent)) { processedParents.add(m.parent); return <React.Fragment key={`grp-${m.parent}`}><tr className="bg-white font-bold italic"><td colSpan="12" className="pl-2 py-0.5 text-[11px]">{m.parent}</td></tr>{renderRow(m)}</React.Fragment>; } return renderRow(m); } return renderRow(m); })}</React.Fragment>);
            };
            const myEkskulList = nilaiEkskul.filter(n => n.siswa_id === siswa.id).map(n => { const ref = ekskulRef.find(e => e.id === n.ekskul_id); return { nama: ref?.nama || '-', predikat: n.predikat }; });
            return (
                <div className="w-full h-full bg-white text-black p-0 page-break relative text-[11pt]">
                    <div className="flex items-center justify-between border-b-4 border-double border-black pb-2 mb-2"><div className="w-16 h-16 flex items-center justify-center font-bold text-center text-xs">{logo && logo.image ? (<img src={logo.image} alt="Logo" className="w-full h-full object-contain" onError={(e) => e.target.style.display = 'none'} />) : "LOGO"}</div><div className="text-center flex-1"><h1 className="font-bold text-lg uppercase leading-tight">LAPORAN HASIL BELAJAR TENGAH SEMESTER</h1><h2 className="font-bold text-md">{sekolah.nama}</h2><p className="text-[11px]">{sekolah.alamat}</p></div><div className="w-16"></div></div>
                    <div className="flex justify-between mb-2 text-[11px] font-sans"><table className="w-[60%]"><tbody><tr><td className="w-24">Nama</td><td className="w-2">:</td><td className="font-bold uppercase">{siswa.nama}</td></tr><tr><td>Nomor Induk</td><td>:</td><td>{siswa.nisn}</td></tr><tr><td>Kelas</td><td>:</td><td>{siswa.kelas} / {siswa.fase}</td></tr></tbody></table><table className="w-[35%]"><tbody><tr><td className="w-24">Tahun Ajaran</td><td className="w-2">:</td><td>{sekolah.tahunPelajaran}</td></tr><tr><td>Semester</td><td>:</td><td>{sekolah.semester}</td></tr></tbody></table></div>
                    <h3 className="font-bold mb-0.5 text-[12px] underline">A. Nilai Akademik</h3><table className="print-table mb-2"><thead className="text-center font-bold"><tr><th rowSpan="2" className="w-6">No</th><th rowSpan="2">Mata Pelajaran</th><th rowSpan="2" className="w-8">KKM</th><th colSpan="5" className="h-4">Sumatif</th><th rowSpan="2" className="w-8">Rata</th><th rowSpan="2" className="w-8">STS</th><th rowSpan="2" className="w-8">Akhir</th><th rowSpan="2" className="w-8">Pred</th></tr><tr className="text-[11px]"><th className="w-6">1</th><th className="w-6">2</th><th className="w-6">3</th><th className="w-6">4</th><th className="w-6">5</th></tr></thead><tbody>{renderGroupWithHeader('A', 'Kelompok A (Umum)')}{renderGroupWithHeader('B', 'Kelompok B (Muatan Lokal)')}{renderGroupWithHeader('C', 'Kelompok C (Peminatan)')}</tbody></table>
                    <div className="flex gap-2 mb-4"><div className="flex-1"><h3 className="font-bold mb-0.5 text-[12px] underline">B. Ekstrakurikuler</h3><table className="print-table w-full"><thead className=""><tr><th className="w-6">No</th><th>Kegiatan</th><th className="w-12">Predikat</th></tr></thead><tbody>{myEkskulList.length > 0 ? myEkskulList.map((e,i)=>(<tr key={i}><td className="text-center">{i+1}</td><td className="pl-2">{e.nama}</td><td className="text-center">{e.predikat}</td></tr>)) : <tr><td colSpan="3" className="text-center">-</td></tr>}</tbody></table></div><div className="w-[35%]"><h3 className="font-bold mb-0.5 text-[12px] underline">C. Ketidakhadiran</h3><table className="print-table w-full"><tbody><tr><td>Sakit</td><td className="text-center w-12">{myAbsen.sakit}</td><td>Hari</td></tr><tr><td>Izin</td><td className="text-center">{myAbsen.izin}</td><td>Hari</td></tr><tr><td>Tanpa Ket.</td><td className="text-center">{myAbsen.alpa}</td><td>Hari</td></tr></tbody></table></div></div>
                    <div className="flex justify-between mt-2 px-8 text-center text-[12px]"><div><p className="mb-10">Mengetahui,<br/>Orang Tua/Wali</p><p className="border-b border-black w-40 mx-auto"></p></div><div><p className="mb-10">{logo.kota}, {logo.tgl_rapor}<br/>Wali Kelas</p><p className="font-bold underline">{waliKelasName}</p><p>NIP. -</p></div></div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            // Updated Key to ensure fresh data for new schema
            const [data, setData] = useStickyState(SEED_DATA, 'erapor_v55_dynamic_role_v4');
            const { data: fbData, updateData, loading, authUser } = useFirebaseData();
            const [user, setUser] = useStickyState(null, 'erapor_v55_user_session_v4');
            const [page, setPage] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [notification, setNotification] = useState(null);
            const [printQueue, setPrintQueue] = useState([]);
            const [modal, setModal] = useState({ show: false, type: '', data: null });
            const [formData, setFormData] = useState({});

            // Sync Firebase Data to Local State
            useEffect(() => {
                if (fbData) setData(fbData);
            }, [fbData, setData]);

            const currentGuru = useMemo(() => {
                if (!user || user.role !== 'guru' || !data) return null;
                
                if (user.id && String(user.id).startsWith('usr-g-')) {
                    const guruId = user.id.replace('usr-g-', '');
                    const byId = data.guru.find(g => String(g.id) === String(guruId));
                    if (byId) return byId;
                }

                if (user.nip) {
                    const byNip = data.guru.find(g => g.nip && String(g.nip).trim() === String(user.nip).trim());
                    if (byNip) return byNip;
                }

                return data.guru.find(g => g.nama && user.nama && g.nama.trim().toLowerCase() === user.nama.trim().toLowerCase());
            }, [user, data]);

            const isWalas = useMemo(() => {
                if (!currentGuru) return false;
                return currentGuru.tugasTambahan && currentGuru.tugasTambahan.toLowerCase().includes('wali kelas');
            }, [currentGuru]);

            const notify = (message, type='success') => setNotification({message, type});
            const handleLogout = () => { if(confirm('Yakin ingin keluar?')) { setUser(null); setPage('dashboard'); } };
            const handlePrint = (studentList) => { 
                if (studentList.length === 0) return notify('Tidak ada siswa di kelas ini', 'error');
                setPrintQueue(studentList); 
                setTimeout(() => window.print(), 500); 
            };
            const handleMenuClick = (targetPage) => { setPage(targetPage); if (window.innerWidth < 1024) setSidebarOpen(false); };

            const processImport = (event, type) => { 
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(fileData, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    updateData(prev => {
                        if (type === 'siswa') {
                            const newSiswa = json.map(row => ({ id: Date.now() + Math.random(), nisn: String(row['NOMOR INDUK'] || row['Nomor Induk'] || row['nomor induk'] || row['NISN'] || row['nisn'] || ''), nama: String(row['NAMA'] || row['nama'] || row['NAMA LENGKAP'] || ''), kelas: String(row['KELAS'] || row['kelas'] || ''), fase: String(row['FASE'] || row['fase'] || 'E'), no_absen: row['NO_ABSEN'] || row['no_absen'] || 0 })).filter(s => s.nama);
                            notify(`Berhasil import ${newSiswa.length} siswa!`, 'success');
                            return { ...prev, siswa: [...prev.siswa, ...newSiswa] };
                        } else if (type === 'guru') {
                            const newGuru = json.map(row => ({ id: Date.now() + Math.random(), nip: String(row['NIP'] || row['nip'] || ''), nama: String(row['NAMA'] || row['nama'] || ''), mapel: String(row['MAPEL'] || row['mapel'] || ''), tugasTambahan: String(row['TUGAS_TAMBAHAN'] || row['tugas_tambahan'] || '-') })).filter(g => g.nama);
                            notify(`Berhasil import ${newGuru.length} guru!`, 'success');
                            return { ...prev, guru: [...prev.guru, ...newGuru] };
                        }
                        return prev;
                    });
                };
                reader.readAsArrayBuffer(file); event.target.value = null;
            };

            const downloadTemplate = (type) => { 
                 const wb = XLSX.utils.book_new(); let headers = []; if(type === 'siswa') headers = [['NOMOR INDUK', 'NAMA', 'KELAS', 'FASE', 'NO_ABSEN']]; if(type === 'guru') headers = [['NIP', 'NAMA', 'MAPEL', 'TUGAS_TAMBAHAN']]; const ws = XLSX.utils.aoa_to_sheet(headers); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, `template_import_${type}.xlsx`);
            };

            const BackupRestore = ({ data, setData, notify }) => { /* ... existing implementation ... */ 
                const fileInputRef = useRef(null);
                const handleBackup = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); const downloadAnchorNode = document.createElement('a'); const timestamp = new Date().toISOString().slice(0,10); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `backup_erapor_${timestamp}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); notify("Backup data berhasil diunduh!", "success"); };
                const handleRestore = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const json = JSON.parse(e.target.result); if (json.sekolah && json.users && json.siswa && json.nilaiMapel) { if(confirm("Apakah Anda yakin ingin memulihkan data? Data saat ini akan ditimpa!")) { setData(json); notify("Data berhasil dipulihkan!", "success"); } } else { notify("Format file backup tidak valid.", "error"); } } catch (err) { notify("Gagal membaca file backup.", "error"); } }; reader.readAsText(file); event.target.value = null; };
                return (<div className="space-y-6 animate-fade"><h2 className="text-2xl font-bold text-slate-800">Backup & Restore Data</h2><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-xl border shadow-sm flex flex-col justify-between"><div><div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mb-4"><Icon name="download-cloud" size={24}/></div><h3 className="font-bold text-lg mb-2">Backup Data</h3><p className="text-slate-500 text-sm mb-6">Unduh seluruh data aplikasi (Siswa, Guru, Nilai, Pengaturan) ke dalam file JSON untuk disimpan sebagai cadangan.</p></div><button onClick={handleBackup} className="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2"><Icon name="download" size={18}/> Download Backup</button></div><div className="bg-white p-6 rounded-xl border shadow-sm flex flex-col justify-between"><div><div className="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center mb-4"><Icon name="upload-cloud" size={24}/></div><h3 className="font-bold text-lg mb-2">Restore Data</h3><p className="text-slate-500 text-sm mb-6">Pulihkan data aplikasi dari file backup JSON. <span className="text-red-500 font-bold">Peringatan: Data saat ini akan ditimpa!</span></p></div><input type="file" ref={fileInputRef} accept=".json" className="hidden" onChange={handleRestore} /><button onClick={() => fileInputRef.current.click()} className="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center gap-2"><Icon name="refresh-ccw" size={18}/> Restore Data</button></div></div></div>);
            };

            const openModal = (type, item=null) => { setModal({ show:true, type, data:item }); setFormData(item || {}); }
            
            const saveData = () => {
                const type = modal.type; 
                
                updateData(prevData => {
                    let updatedList = [...(type === 'ekskul' ? prevData.ekskulRef : prevData[type])];
                    let newUsers = [...prevData.users];

                    if (modal.data) { 
                        const idx = updatedList.findIndex(x => x.id === modal.data.id); 
                        updatedList[idx] = { ...updatedList[idx], ...formData };
                        
                        // --- SYNC GURU TO USER ACCOUNTS (Robust) ---
                        if (type === 'guru') {
                            const updatedGuru = updatedList[idx];
                            newUsers = newUsers.map(u => {
                                const isLinked = u.id === `usr-g-${modal.data.id}` || (u.nama === modal.data.nama && u.role === 'guru');
                                if (isLinked) {
                                    return { ...u, nama: updatedGuru.nama, nip: updatedGuru.nip };
                                }
                                return u;
                            });
                        }
                    } else { 
                        updatedList.push({ id: Date.now(), ...formData }); 
                    }

                    const newState = { ...prevData };
                    if(type === 'ekskul') newState.ekskulRef = updatedList;
                    else newState[type] = updatedList;
                    
                    if (type === 'guru') newState.users = newUsers;

                    return newState;
                });

                setModal({ show:false, type:'', data:null }); 
                notify('Data berhasil disimpan');
            };

            const deleteItem = (key, id) => { 
                if(confirm('Hapus data ini?')) { 
                    updateData(prev => {
                        const newState = { ...prev };
                        if(key === 'ekskulRef') newState.ekskulRef = prev.ekskulRef.filter(i => i.id !== id);
                        else newState[key] = prev[key].filter(i => i.id !== id);
                        return newState;
                    });
                    notify('Data berhasil dihapus'); 
                } 
            };
            
            const renderContent = () => {
                // Ensure Login Page gets latest user data
                if (!user) return <LoginPage onLogin={u => { setUser(u); notify(`Selamat Datang, ${u.nama}`); }} logo={data?.logo} users={data?.users || []} />;
                if (!data) return <div className="p-10 text-center">Memuat Data...</div>;

                switch(page) {
                    case 'dashboard': return <Dashboard data={data} />;
                    case 'data_sekolah': return <DataSekolah data={data} setData={updateData} notify={notify} />;
                    case 'data_logo': return <LogoSetting data={data} setData={updateData} notify={notify} />;
                    case 'data_akun': return <DataAkun data={data} setData={updateData} notify={notify} />;
                    case 'siswa': return <TableView title="Data Siswa" heads={['Nomor Induk','Nama','Kelas','Fase']} data={data.siswa} searchKeys={['nama','nisn']} filterOptions={data.kelas} filterKey="kelas" renderRow={i=><><td className="p-4">{i.nisn}</td><td className="p-4 font-bold">{i.nama}</td><td className="p-4">{i.kelas}</td><td className="p-4">{i.fase}</td></>} onAdd={()=>openModal('siswa')} onEdit={d=>openModal('siswa',d)} onDelete={id=>deleteItem('siswa', id)} onImport={(e) => processImport(e, 'siswa')} onDownloadTemplate={() => downloadTemplate('siswa')} />;
                    case 'guru': return <TableView title="Data Guru" heads={['NIP','Nama','Mapel','Tugas','Kelas Mengajar']} data={data.guru} searchKeys={['nama','nip']} renderRow={i=><><td className="p-4">{i.nip}</td><td className="p-4 font-bold">{i.nama}</td><td className="p-4">{i.mapel}</td><td className="p-4 text-sm">{i.tugasTambahan || '-'}</td><td className="p-4 text-xs italic">{(i.kelasMengajar||[]).join(', ') || '-'}</td></>} onAdd={()=>openModal('guru')} onEdit={d=>openModal('guru',d)} onDelete={id=>deleteItem('guru', id)} onImport={(e) => processImport(e, 'guru')} onDownloadTemplate={() => downloadTemplate('guru')} />;
                    case 'mapel': return <TableView title="Data Mapel" heads={['Nama','Kelompok','Kelas']} data={data.mapel} searchKeys={['nama']} filterOptions={data.kelas} filterKey="kelas" renderRow={i=><><td className="p-4 font-medium">{i.nama}</td><td className="p-4 text-center">{i.kelompok}</td><td className="p-4 text-xs italic">{(i.kelas||[]).join(', ') || 'Semua'}</td></>} onAdd={()=>openModal('mapel')} onEdit={d=>openModal('mapel',d)} onDelete={id=>deleteItem('mapel', id)} />;
                    case 'kelas': return <TableView title="Data Kelas" heads={['Nama','Tingkat','Jurusan']} data={data.kelas} searchKeys={['nama']} renderRow={i=><><td className="p-4 font-bold">{i.nama}</td><td className="p-4">{i.tingkat}</td><td className="p-4">{i.jurusan}</td></>} onAdd={()=>openModal('kelas')} onEdit={d=>openModal('kelas',d)} onDelete={id=>deleteItem('kelas', id)} />;
                    case 'referensi_ekskul': return <TableView title="Data Ekstrakurikuler" heads={['Nama Kegiatan']} data={data.ekskulRef} searchKeys={['nama']} renderRow={i=><td className="p-4 font-medium">{i.nama}</td>} onAdd={()=>openModal('ekskul')} onEdit={d=>openModal('ekskul',d)} onDelete={id=>deleteItem('ekskulRef', id)} />;
                    case 'mapping': return <MappingRapor dataMapel={data.mapel} classList={data.kelas} setData={updateData} notify={notify} />;
                    case 'input_nilai': return user.role !== 'siswa' ? <InputNilai data={data} setData={updateData} notify={notify} user={user} /> : <div className="p-10 text-center">Akses Ditolak</div>;
                    case 'input_absensi': return (user.role === 'admin' || isWalas) ? <InputAbsensi data={data} setData={updateData} notify={notify} user={user} currentGuru={currentGuru} /> : <div className="p-10 text-center text-red-500 font-bold">Akses Ditolak: Khusus Wali Kelas</div>;
                    case 'input_ekskul': return (user.role === 'admin' || isWalas) ? <InputEkskul data={data} setData={updateData} notify={notify} user={user} currentGuru={currentGuru} /> : <div className="p-10 text-center text-red-500 font-bold">Akses Ditolak: Khusus Wali Kelas</div>;
                    case 'cetak_leger': return <CetakLeger data={data} notify={notify} user={user} />;
                    case 'cetak': return (user.role === 'admin' || isWalas) ? <CetakRaporSisipan data={data} handlePrint={handlePrint} notify={notify} user={user} currentGuru={currentGuru} /> : <div className="p-10 text-center text-red-500 font-bold">Akses Ditolak: Khusus Wali Kelas</div>;
                    case 'backup_restore': return <BackupRestore data={data} setData={updateData} notify={notify} />;
                    default: return <div>Halaman tidak ditemukan</div>;
                }
            };

            // Loading state saat pertama kali fetch data
            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 flex-col gap-4">
                    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-secondary"></div>
                    <div className="text-slate-500 text-sm">Menghubungkan ke Server...</div>
                </div>
            );

            if (!user) return <LoginPage onLogin={u => { setUser(u); notify(`Selamat Datang, ${u.nama}`); }} logo={data?.logo} users={data?.users || []} />;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-50">
                    {notification && <Toast message={notification.message} type={notification.type} onClose={()=>setNotification(null)} />}
                    <Modal isOpen={modal.show} onClose={()=>setModal({...modal,show:false})} title={modal.data ? 'Edit Data' : 'Tambah Data'}>
                        <div className="space-y-2">
                             {modal.type === 'siswa' && <><FormInput label="Nomor Induk" value={formData.nisn} onChange={v=>setFormData({...formData,nisn:v})}/><FormInput label="Nama" value={formData.nama} onChange={v=>setFormData({...formData,nama:v})}/><FormInput label="Kelas" value={formData.kelas} onChange={v=>setFormData({...formData,kelas:v})}/></>}
                             
                             {modal.type === 'guru' && (
                                <>
                                    <FormInput label="NIP" value={formData.nip} onChange={v=>setFormData({...formData,nip:v})}/>
                                    <FormInput label="Nama" value={formData.nama} onChange={v=>setFormData({...formData,nama:v})}/>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Mata Pelajaran</label>
                                        <select 
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                            value={formData.mapel || ''}
                                            onChange={e => setFormData({...formData, mapel: e.target.value})}
                                        >
                                            <option value="">-- Pilih Mata Pelajaran --</option>
                                            {data.mapel.sort((a,b) => a.nama.localeCompare(b.nama)).map(m => (
                                                <option key={m.id} value={m.nama}>{m.nama}</option>
                                            ))}
                                        </select>
                                        <p className="text-xs text-slate-500 mt-1">* Jika guru mengampu lebih dari 1 mapel, tambahkan data guru baru dengan mapel berbeda.</p>
                                    </div>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Tugas Tambahan</label>
                                        <select 
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                            value={formData.tugasTambahan || '-'}
                                            onChange={e => setFormData({...formData, tugasTambahan: e.target.value})}
                                        >
                                            <option value="-">Tidak Ada</option>
                                            {data.kelas.map(k => (
                                                <option key={k.id} value={`Wali Kelas ${k.nama}`}>Wali Kelas {k.nama}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <ClassSelector label="Kelas Mengajar" availableClasses={data.kelas} selectedClasses={formData.kelasMengajar} onChange={v=>setFormData({...formData,kelasMengajar:v})}/>
                                </>
                             )}
                             
                             {modal.type === 'mapel' && <><FormInput label="Nama" value={formData.nama} onChange={v=>setFormData({...formData,nama:v})}/><FormInput label="Kelompok" value={formData.kelompok} onChange={v=>setFormData({...formData,kelompok:v})}/><ClassSelector label="Diajarkan di Kelas" availableClasses={data.kelas} selectedClasses={formData.kelas} onChange={v=>setFormData({...formData,kelas:v})}/></>}
                             {modal.type === 'kelas' && <><FormInput label="Nama" value={formData.nama} onChange={v=>setFormData({...formData,nama:v})}/><FormInput label="Jurusan" value={formData.jurusan} onChange={v=>setFormData({...formData,jurusan:v})}/></>}
                             {modal.type === 'ekskul' && <FormInput label="Nama Kegiatan" value={formData.nama} onChange={v=>setFormData({...formData,nama:v})}/>}
                             <button onClick={saveData} className="w-full bg-secondary text-white py-2 rounded font-bold mt-4">Simpan</button>
                        </div>
                    </Modal>
                    <div className="print-only fixed inset-0 bg-white z-[9999]">{printQueue.map(s => <PrintRapor key={s.id} data={data} siswa={s} />)}</div>
                    
                    <aside className={`bg-primary text-slate-300 w-64 flex flex-col shadow-2xl transition-all duration-300 no-print ${sidebarOpen ? 'translate-x-0' : '-translate-x-64 absolute h-full z-40'}`}>
                        <div className="h-16 flex items-center px-6 font-bold text-xl tracking-tight text-white border-b border-slate-700">{data.logo.image ? (<img src={data.logo.image} className="h-8 w-auto mr-2 object-contain" alt="Logo" onError={(e) => e.target.style.display = 'none'} />) : (<span className="text-secondary mr-1">e</span>)} Rapor<span className="font-light opacity-50 ml-1">Pro</span></div>
                        <div className="flex-1 overflow-y-auto py-6 space-y-1">
                            <div className="px-6 text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Main</div>
                            <button onClick={()=>handleMenuClick('dashboard')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='dashboard' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="grid"/> Dashboard</button>
                            {user.role === 'admin' && (
                                <>
                                    <div className="px-6 text-xs font-bold text-slate-500 uppercase tracking-widest mt-6 mb-2">Master Data</div>
                                    <button onClick={()=>handleMenuClick('data_sekolah')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='data_sekolah' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="school"/> Sekolah</button>
                                    <button onClick={()=>handleMenuClick('data_akun')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='data_akun' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="key"/> Data Akun</button>
                                    <button onClick={()=>handleMenuClick('siswa')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='siswa' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="users"/> Data Siswa</button>
                                    <button onClick={()=>handleMenuClick('guru')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='guru' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="briefcase"/> Data Guru</button>
                                    <button onClick={()=>handleMenuClick('kelas')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='kelas' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="layers"/> Data Kelas</button>
                                    <button onClick={()=>handleMenuClick('mapel')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='mapel' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="book"/> Data Mapel</button>
                                    <button onClick={()=>handleMenuClick('referensi_ekskul')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='referensi_ekskul' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="activity"/> Data Ekskul</button>
                                    <button onClick={()=>handleMenuClick('mapping')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='mapping' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="sliders"/> Mapping Rapor</button>
                                    <button onClick={()=>handleMenuClick('data_logo')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='data_logo' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="pen-tool"/> Logo & TTD</button>
                                </>
                            )}
                            {(user.role === 'admin' || user.role === 'guru') && (
                                <>
                                    <div className="px-6 text-xs font-bold text-slate-500 uppercase tracking-widest mt-6 mb-2">Akademik</div>
                                    <button onClick={()=>handleMenuClick('input_nilai')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='input_nilai' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="pen-tool"/> Input Nilai</button>
                                    <button onClick={()=>handleMenuClick('cetak_leger')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='cetak_leger' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="file-text"/> Cetak Leger</button>
                                    {(user.role === 'admin' || isWalas) && (
                                        <>
                                            <button onClick={()=>handleMenuClick('input_absensi')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='input_absensi' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="calendar"/> Input Absensi</button>
                                            <button onClick={()=>handleMenuClick('input_ekskul')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='input_ekskul' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="award"/> Input Nilai Ekskul</button>
                                            <button onClick={()=>handleMenuClick('cetak')} className={`w-full px-6 py-3 text-left hover:bg-slate-800 hover:text-white transition flex items-center gap-3 ${page==='cetak' && 'bg-slate-800 text-white border-r-4 border-secondary'}`}><Icon name="printer"/> Cetak Rapor Sisipan</button>
                                        </>
                                    )}
                                </>
                            )}
                        </div>
                         <div className="p-4 border-t border-slate-700">
                             <button onClick={() => handleMenuClick('backup_restore')} className="w-full mb-3 text-slate-400 hover:text-white text-sm flex items-center gap-3 px-2 py-1 rounded hover:bg-slate-700 transition"><Icon name="database" size={16}/> Backup & Restore</button>
                            <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold">{user.nama.charAt(0)}</div><div className="overflow-hidden"><p className="text-sm font-bold text-white truncate">{user.nama}</p><p className="text-xs text-slate-500 capitalize">{user.role}{isWalas ? ' (Walas)' : ''}</p></div></div>
                            <button onClick={handleLogout} className="w-full bg-red-600/20 text-red-400 py-2 rounded text-sm hover:bg-red-600 hover:text-white transition flex items-center justify-center gap-2"><Icon name="log-out" size={16}/> Keluar</button>
                        </div>
                    </aside>
                    <main className={`flex-1 flex flex-col h-full transition-all duration-300 no-print`}>
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-30"><button onClick={()=>setSidebarOpen(!sidebarOpen)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition"><Icon name="menu"/></button><div className="flex items-center gap-4"><span className="text-sm text-slate-500 hidden md:block">{data.sekolah.nama}</span><div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 border"><Icon name="bell" size={16}/></div></div></header>
                        <div className="flex-1 overflow-y-auto p-6 md:p-8"><div className="max-w-6xl mx-auto">{renderContent()}</div></div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
